name: Simple CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-basic:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9

    - name: Install basic dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        pip install PyQt6
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install transformers huggingface-hub requests psutil

    - name: Run basic tests
      run: |
        pytest tests/test_config.py -v
      env:
        QT_QPA_PLATFORM: offscreen

    - name: Test application import
      run: |
        python -c "import sys; sys.path.append('src'); from src.core.config import Config; print('Config OK')"
        python -c "import sys; sys.path.append('src'); from src.core.ollama_client import SevenXEngine; print('Engine OK')"

  build-exe:
    runs-on: windows-latest
    needs: test-basic
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pillow
        pip install PyQt6
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install transformers huggingface-hub requests psutil

    - name: Create icon
      run: python create_icon.py

    - name: Build executable with optimized settings
      run: |
        pyinstaller --onefile --windowed --name "SevenX Studio" ^
          --icon=assets/icon.ico ^
          --add-data "src;src" ^
          --hidden-import=torch ^
          --hidden-import=transformers ^
          --hidden-import=huggingface_hub ^
          --hidden-import=PyQt6.QtCore ^
          --hidden-import=PyQt6.QtWidgets ^
          --hidden-import=PyQt6.QtGui ^
          --exclude-module=matplotlib ^
          --exclude-module=scipy ^
          --exclude-module=pandas ^
          main.py

    - name: Get file size
      run: |
        $size = (Get-Item "dist/SevenX Studio.exe").Length / 1MB
        echo "Executable size: $([math]::Round($size, 1)) MB"

    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: SevenX-Studio-v1.0.0-Windows
        path: dist/SevenX Studio.exe

    - name: Create portable package
      run: |
        mkdir SevenX_Studio_Portable
        copy "dist\SevenX Studio.exe" SevenX_Studio_Portable\
        copy README.md SevenX_Studio_Portable\
        copy LICENSE SevenX_Studio_Portable\
        copy INSTALL.md SevenX_Studio_Portable\
        echo "SevenX Studio v1.0.0 - Versao Portatil" > SevenX_Studio_Portable\INFO.txt
        echo "" >> SevenX_Studio_Portable\INFO.txt
        echo "Execute 'SevenX Studio.exe' para iniciar" >> SevenX_Studio_Portable\INFO.txt
        echo "Veja README.md para instrucoes completas" >> SevenX_Studio_Portable\INFO.txt

    - name: Upload portable package
      uses: actions/upload-artifact@v4
      with:
        name: SevenX-Studio-Portable-v1.0.0
        path: SevenX_Studio_Portable/

  # Release ser√° criada manualmente usando os artifacts